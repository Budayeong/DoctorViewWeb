<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.edu.springboot.board.IFreeboardService">
	
	<!-- 게시글 목록: 자유게시판의 게시글 개수를 카운트 -->
	<select id="countPost"
		resultType="int"
		parameterType="com.edu.springboot.board.ParameterDTO">
		SELECT COUNT(*) FROM board WHERE boardname='freeboard'
		<!-- 검색어가 있는 경우 -->
		<if test="searchWord!=null and !searchWord.equals('')">
			AND ${searchField} LIKE '%'||#{searchWord}||'%'
		</if>
	</select>
	
	<!-- 게시글 목록: 자유게시판에서 한 페이지에 출력할 게시글을 인출 -->
	<select id="listPost"
		resultType="com.edu.springboot.board.BoardDTO"
		parameterType="com.edu.springboot.board.ParameterDTO">
		SELECT * FROM (
			SELECT Tb.*, rownum rNum FROM (
				SELECT * FROM board WHERE boardname='freeboard'
					<if test="searchWord!=null and !searchWord.equals('')">
						AND ${searchField} LIKE '%'||#{searchWord}||'%'
					</if>
				ORDER BY board_idx DESC
			) Tb
		)
		WHERE rNum<![CDATA[>=]]>#{start} AND rNum<![CDATA[<=]]>#{end}
	</select>
	
	<!-- 게시글 조회: 게시글의 일련번호를 DTO를 통해 받은 후 조회하고 결과를 다시 DTO에 저장 -->
	<select id="viewPost"
		resultType="com.edu.springboot.board.BoardDTO"
		parameterType="com.edu.springboot.board.ParameterDTO">
		SELECT * FROM board WHERE board_idx=#{board_idx}
	</select>
	
	<!-- 게시글 조회: 자유게시판에서 게시글의 조회수 증가 -->
	<update id="plusVisitcount"
		parameterType="com.edu.springboot.board.ParameterDTO">
		UPDATE board SET visitcount=visitcount+1 WHERE board_idx=#{board_idx}
	</update>
	
	<!-- 게시글 작성 -->
	<insert id="writePost">
		INSERT INTO board (board_idx, boardname, title, content, writer_ref)
		VALUES (seq_board_idx.nextval, 'freeboard', #{param1}, #{param2}, #{param3})
	</insert>
	
	<!-- 게시글 수정 -->
	<update id="editPost"
		parameterType="com.edu.springboot.board.ParameterDTO">
		UPDATE board SET title=#{title}, content=#{content}
		WHERE board_idx=#{board_idx}
	</update>
	
	<!-- 게시글 삭제 -->
	<delete id="deletePost">
		DELETE FROM board WHERE board_idx=#{param1}
	</delete>
	
	<!-- 댓글 목록: 자유게시판에서 특정 게시물에 해당하는 댓글을 인출 -->
	<select id="listComments"
		resultType="com.edu.springboot.board.CommentsDTO"
		parameterType="com.edu.springboot.board.BoardDTO">
		SELECT * FROM comments WHERE board_ref=#{board_idx}
		ORDER BY postdate DESC
	</select>
	
	<!-- 댓글 작성 -->
	<insert id = "writeComment">
		INSERT INTO comments (comm_idx, content, board_ref, writer_ref)
		VALUES (seq_comments_idx.nextval, #{param3}, #{param2}, #{param1})
	</insert>

	<!-- 댓글 수정 -->
	<update id="editComment">
		UPDATE comments SET content=#{param2}
		WHERE comm_idx=#{param1}
	</update>

	<!-- 댓글 삭제 -->
	<delete id="deleteComment">
		DELETE FROM comments WHERE comm_idx=#{param1}
	</delete>
	
</mapper>